<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国家/地区分布模块测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-input {
            width: 100%;
            height: 150px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>国家/地区分布模块测试</h1>
        
        <div class="test-section">
            <div class="test-title">测试数据（基于您提供的图片）</div>
            <textarea class="test-input" id="testData">
教育技术学文献发表国家情况统计表（前20名）

排名1：美国(USA) - 302篇文献，占比30.26%，中心性0.49，发表年份2010
排名2：澳大利亚(AUSTRALIA) - 80篇文献，占比8.02%，中心性0.13，发表年份2010
排名3：中国(PEOPLES R CHINA) - 66篇文献，占比6.61%，中心性0.03，发表年份2015
排名4：台湾(TAIWAN) - 63篇文献，占比6.31%，中心性0.01，发表年份2012
排名5：荷兰(NETHERLANDS) - 43篇文献，占比4.31%，中心性0.17，发表年份2011

参与国家/地区总数：20个
国际合作文献数：1567篇
国际合作占比：45.6%
            </textarea>
            <button class="test-button" onclick="testCountryDistribution()">测试国家/地区分布解析</button>
            <div class="test-result" id="testResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">字段映射验证</div>
            <div class="test-result" id="fieldMappingResult"></div>
        </div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="config.js"></script>
    <script src="api-config.js"></script>
    <script src="prompts/index.js"></script>
    <script src="prompts/country-distribution-prompts.js"></script>
    <script src="ai-core.js"></script>
    <script src="result-display.js"></script>
    <script src="form-init.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            return `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        }

        function testCountryDistribution() {
            const resultDiv = document.getElementById('testResult');
            const testData = document.getElementById('testData').value;
            
            resultDiv.innerHTML = '';
            resultDiv.innerHTML += log('开始测试国家/地区分布模块解析', 'info');
            
            // 1. 测试模块识别
            resultDiv.innerHTML += log('=== 模块识别测试 ===', 'info');
            
            const descriptor = {
                title: '国家/地区分布',
                fields: [
                    { fieldId: 'total_countries', label: '参与国家/地区总数', type: 'number' },
                    { fieldId: 'international_collaboration_papers', label: '国际合作文献数', type: 'number' },
                    { fieldId: 'international_collaboration_ratio', label: '国际合作占比', type: 'number' },
                    { fieldId: 'country_1_name', label: '排名第1的国家名称', type: 'text' },
                    { fieldId: 'country_1_papers', label: '排名第1的国家发文量', type: 'number' },
                    { fieldId: 'country_1_ratio', label: '排名第1的国家占比', type: 'number' },
                    { fieldId: 'country_1_centrality', label: '排名第1的国家中心性', type: 'number' },
                    { fieldId: 'country_2_name', label: '排名第2的国家名称', type: 'text' },
                    { fieldId: 'country_2_papers', label: '排名第2的国家发文量', type: 'number' },
                    { fieldId: 'country_2_ratio', label: '排名第2的国家占比', type: 'number' },
                    { fieldId: 'country_2_centrality', label: '排名第2的国家中心性', type: 'number' },
                    { fieldId: 'country_3_name', label: '排名第3的国家名称', type: 'text' },
                    { fieldId: 'country_3_papers', label: '排名第3的国家发文量', type: 'number' },
                    { fieldId: 'country_3_ratio', label: '排名第3的国家占比', type: 'number' },
                    { fieldId: 'country_3_centrality', label: '排名第3的国家中心性', type: 'number' },
                    { fieldId: 'country_4_name', label: '排名第4的国家名称', type: 'text' },
                    { fieldId: 'country_4_papers', label: '排名第4的国家发文量', type: 'number' },
                    { fieldId: 'country_4_ratio', label: '排名第4的国家占比', type: 'number' },
                    { fieldId: 'country_4_centrality', label: '排名第4的国家中心性', type: 'number' },
                    { fieldId: 'country_5_name', label: '排名第5的国家名称', type: 'text' },
                    { fieldId: 'country_5_papers', label: '排名第5的国家发文量', type: 'number' },
                    { fieldId: 'country_5_ratio', label: '排名第5的国家占比', type: 'number' },
                    { fieldId: 'country_5_centrality', label: '排名第5的国家中心性', type: 'number' }
                ]
            };
            
            if (typeof getModuleNameFromDescriptor === 'function') {
                const moduleName = getModuleNameFromDescriptor(descriptor);
                resultDiv.innerHTML += log(`模块名称: ${moduleName}`, 'info');
                
                if (moduleName === 'country-distribution') {
                    resultDiv.innerHTML += log('✓ 模块识别正确', 'success');
                } else {
                    resultDiv.innerHTML += log(`✗ 模块识别错误，期望 country-distribution，实际 ${moduleName}`, 'error');
                }
            } else {
                resultDiv.innerHTML += log('✗ getModuleNameFromDescriptor 函数不可用', 'error');
            }
            
            // 2. 测试提示词获取
            resultDiv.innerHTML += log('=== 提示词获取测试 ===', 'info');
            
            if (typeof getModulePrompt === 'function') {
                const prompt = getModulePrompt('country-distribution');
                if (prompt) {
                    resultDiv.innerHTML += log('✓ 成功获取国家/地区分布模块提示词', 'success');
                    resultDiv.innerHTML += log(`提示词长度: ${prompt.length} 字符`, 'info');
                } else {
                    resultDiv.innerHTML += log('✗ 未找到国家/地区分布模块提示词', 'error');
                }
            } else {
                resultDiv.innerHTML += log('✗ getModulePrompt 函数不可用', 'error');
            }
            
            // 3. 测试字段映射
            resultDiv.innerHTML += log('=== 字段映射测试 ===', 'info');
            
            const expectedFields = [
                'total_countries', 'international_collaboration_papers', 'international_collaboration_ratio',
                'country_1_name', 'country_1_papers', 'country_1_ratio', 'country_1_centrality',
                'country_2_name', 'country_2_papers', 'country_2_ratio', 'country_2_centrality',
                'country_3_name', 'country_3_papers', 'country_3_ratio', 'country_3_centrality',
                'country_4_name', 'country_4_papers', 'country_4_ratio', 'country_4_centrality',
                'country_5_name', 'country_5_papers', 'country_5_ratio', 'country_5_centrality'
            ];
            
            const actualFields = descriptor.fields.map(f => f.fieldId);
            const missingFields = expectedFields.filter(f => !actualFields.includes(f));
            const extraFields = actualFields.filter(f => !expectedFields.includes(f));
            
            if (missingFields.length === 0 && extraFields.length === 0) {
                resultDiv.innerHTML += log('✓ 字段映射完全匹配', 'success');
            } else {
                if (missingFields.length > 0) {
                    resultDiv.innerHTML += log(`✗ 缺少字段: ${missingFields.join(', ')}`, 'error');
                }
                if (extraFields.length > 0) {
                    resultDiv.innerHTML += log(`✗ 多余字段: ${extraFields.join(', ')}`, 'error');
                }
            }
            
            // 4. 模拟AI解析结果
            resultDiv.innerHTML += log('=== 模拟AI解析结果 ===', 'info');
            
            const mockExtractedData = {
                "total_countries": 20,
                "international_collaboration_papers": 1567,
                "international_collaboration_ratio": 45.6,
                "country_1_name": "美国",
                "country_1_papers": 302,
                "country_1_ratio": 30.26,
                "country_1_centrality": 0.49,
                "country_2_name": "澳大利亚",
                "country_2_papers": 80,
                "country_2_ratio": 8.02,
                "country_2_centrality": 0.13,
                "country_3_name": "中国",
                "country_3_papers": 66,
                "country_3_ratio": 6.61,
                "country_3_centrality": 0.03,
                "country_4_name": "台湾",
                "country_4_papers": 63,
                "country_4_ratio": 6.31,
                "country_4_centrality": 0.01,
                "country_5_name": "荷兰",
                "country_5_papers": 43,
                "country_5_ratio": 4.31,
                "country_5_centrality": 0.17
            };
            
            resultDiv.innerHTML += log('模拟AI解析结果:', 'info');
            resultDiv.innerHTML += JSON.stringify(mockExtractedData, null, 2);
            
            // 5. 测试字段匹配
            resultDiv.innerHTML += log('=== 字段匹配测试 ===', 'info');
            
            const matchedFields = descriptor.fields.filter(f => mockExtractedData[f.fieldId] !== undefined);
            resultDiv.innerHTML += log(`匹配字段数量: ${matchedFields.length}/${descriptor.fields.length}`, 'info');
            
            if (matchedFields.length === descriptor.fields.length) {
                resultDiv.innerHTML += log('✓ 所有字段都匹配成功', 'success');
            } else {
                const unmatchedFields = descriptor.fields.filter(f => mockExtractedData[f.fieldId] === undefined);
                resultDiv.innerHTML += log(`✗ 未匹配字段: ${unmatchedFields.map(f => f.fieldId).join(', ')}`, 'error');
            }
            
            // 6. 显示匹配详情
            resultDiv.innerHTML += log('=== 字段匹配详情 ===', 'info');
            matchedFields.forEach(field => {
                resultDiv.innerHTML += log(`${field.fieldId}: ${mockExtractedData[field.fieldId]}`, 'success');
            });
        }

        function testFieldMapping() {
            const resultDiv = document.getElementById('fieldMappingResult');
            resultDiv.innerHTML = '';
            
            resultDiv.innerHTML += log('=== 字段映射验证 ===', 'info');
            
            // 检查模块信息
            if (window.MODULE_INFO && window.MODULE_INFO['country-distribution']) {
                const moduleInfo = window.MODULE_INFO['country-distribution'];
                resultDiv.innerHTML += log(`模块名称: ${moduleInfo.name}`, 'info');
                resultDiv.innerHTML += log(`模块描述: ${moduleInfo.description}`, 'info');
                resultDiv.innerHTML += log(`字段数量: ${moduleInfo.fields.length}`, 'info');
                
                resultDiv.innerHTML += log('字段列表:', 'info');
                moduleInfo.fields.forEach((field, index) => {
                    resultDiv.innerHTML += log(`  ${index + 1}. ${field}`, 'info');
                });
            } else {
                resultDiv.innerHTML += log('✗ 未找到国家/地区分布模块信息', 'error');
            }
        }

        // 页面加载完成后自动运行字段映射测试
        window.addEventListener('load', function() {
            setTimeout(testFieldMapping, 1000);
        });
    </script>
</body>
</html>
