<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期刊分布模块测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-input {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>期刊分布模块测试</h1>
        
        <div class="test-section">
            <div class="test-title">测试数据（基于您提供的图片）</div>
            <textarea class="test-input" id="testData">
教育技术学Top20期刊发文量统计

排名1：INTERNATIONAL JOURNAL OF TECHNOLOGY AND DESIGN EDUCATION - 86篇文献，占比13.17%
排名2：INTERNATIONAL JOURNAL OF ENGINEERING EDUCATION - 56篇文献，占比8.58%
排名3：THINKING SKILLS AND CREATIVITY - 56篇文献，占比8.58%
排名4：FRONTIERS IN EDUCATION - 33篇文献，占比5.05%
排名5：EDUCATION SCIENCES - 30篇文献，占比4.60%
排名6：INTERNATIONAL JOURNAL OF ART DESIGN EDUCATION - 30篇文献，占比4.60%
排名7：ETR D EDUCATIONAL TECHNOLOGY RESEARCH AND DEVELOPMENT - 23篇文献，占比3.52%
排名8：EDUCATION AND INFORMATION TECHNOLOGIES - 18篇文献，占比2.76%
排名9：COMPUTERS EDUCATION - 14篇文献，占比2.14%
排名10：IEEE TRANSACTIONS ON EDUCATION - 14篇文献，占比2.14%

期刊总数：20种
核心期刊数量：15种
Q1期刊发文量：234篇
高影响因子期刊数量(IF>5)：12种
            </textarea>
            <button class="test-button" onclick="testJournalDistribution()">测试期刊分布解析</button>
            <div class="test-result" id="testResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">字段映射验证</div>
            <div class="test-result" id="fieldMappingResult"></div>
        </div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="config.js"></script>
    <script src="api-config.js"></script>
    <script src="prompts/index.js"></script>
    <script src="prompts/journal-distribution-prompts.js"></script>
    <script src="ai-core.js"></script>
    <script src="result-display.js"></script>
    <script src="form-init.js"></script>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            return `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        }

        function testJournalDistribution() {
            const resultDiv = document.getElementById('testResult');
            const testData = document.getElementById('testData').value;
            
            resultDiv.innerHTML = '';
            resultDiv.innerHTML += log('开始测试期刊分布模块解析', 'info');
            
            // 1. 测试模块识别
            resultDiv.innerHTML += log('=== 模块识别测试 ===', 'info');
            
            const descriptor = {
                title: '期刊分布',
                fields: [
                    { fieldId: 'total_journals', label: '期刊总数', type: 'number' },
                    { fieldId: 'core_journals_count', label: '核心期刊数量', type: 'number' },
                    { fieldId: 'q1_journals_papers', label: 'Q1期刊发文量', type: 'number' },
                    { fieldId: 'high_if_journals_count', label: '高影响因子期刊数量', type: 'number' },
                    { fieldId: 'journal_1_name', label: '排名第1的期刊名称', type: 'text' },
                    { fieldId: 'journal_1_papers', label: '排名第1的期刊发文量', type: 'number' },
                    { fieldId: 'journal_1_ratio', label: '排名第1的期刊占比', type: 'number' },
                    { fieldId: 'journal_1_impact_factor', label: '排名第1的期刊影响因子', type: 'number' },
                    { fieldId: 'journal_2_name', label: '排名第2的期刊名称', type: 'text' },
                    { fieldId: 'journal_2_papers', label: '排名第2的期刊发文量', type: 'number' },
                    { fieldId: 'journal_2_ratio', label: '排名第2的期刊占比', type: 'number' },
                    { fieldId: 'journal_2_impact_factor', label: '排名第2的期刊影响因子', type: 'number' },
                    { fieldId: 'journal_3_name', label: '排名第3的期刊名称', type: 'text' },
                    { fieldId: 'journal_3_papers', label: '排名第3的期刊发文量', type: 'number' },
                    { fieldId: 'journal_3_ratio', label: '排名第3的期刊占比', type: 'number' },
                    { fieldId: 'journal_3_impact_factor', label: '排名第3的期刊影响因子', type: 'number' },
                    { fieldId: 'journal_4_name', label: '排名第4的期刊名称', type: 'text' },
                    { fieldId: 'journal_4_papers', label: '排名第4的期刊发文量', type: 'number' },
                    { fieldId: 'journal_4_ratio', label: '排名第4的期刊占比', type: 'number' },
                    { fieldId: 'journal_4_impact_factor', label: '排名第4的期刊影响因子', type: 'number' },
                    { fieldId: 'journal_5_name', label: '排名第5的期刊名称', type: 'text' },
                    { fieldId: 'journal_5_papers', label: '排名第5的期刊发文量', type: 'number' },
                    { fieldId: 'journal_5_ratio', label: '排名第5的期刊占比', type: 'number' },
                    { fieldId: 'journal_5_impact_factor', label: '排名第5的期刊影响因子', type: 'number' }
                ]
            };
            
            if (typeof getModuleNameFromDescriptor === 'function') {
                const moduleName = getModuleNameFromDescriptor(descriptor);
                resultDiv.innerHTML += log(`模块名称: ${moduleName}`, 'info');
                
                if (moduleName === 'journal-distribution') {
                    resultDiv.innerHTML += log('✓ 模块识别正确', 'success');
                } else {
                    resultDiv.innerHTML += log(`✗ 模块识别错误，期望 journal-distribution，实际 ${moduleName}`, 'error');
                }
            } else {
                resultDiv.innerHTML += log('✗ getModuleNameFromDescriptor 函数不可用', 'error');
            }
            
            // 2. 测试提示词获取
            resultDiv.innerHTML += log('=== 提示词获取测试 ===', 'info');
            
            if (typeof getModulePrompt === 'function') {
                const prompt = getModulePrompt('journal-distribution');
                if (prompt) {
                    resultDiv.innerHTML += log('✓ 成功获取期刊分布模块提示词', 'success');
                    resultDiv.innerHTML += log(`提示词长度: ${prompt.length} 字符`, 'info');
                } else {
                    resultDiv.innerHTML += log('✗ 未找到期刊分布模块提示词', 'error');
                }
            } else {
                resultDiv.innerHTML += log('✗ getModulePrompt 函数不可用', 'error');
            }
            
            // 3. 测试字段映射
            resultDiv.innerHTML += log('=== 字段映射测试 ===', 'info');
            
            const expectedFields = [
                'total_journals', 'core_journals_count', 'q1_journals_papers', 'high_if_journals_count',
                'journal_1_name', 'journal_1_papers', 'journal_1_ratio', 'journal_1_impact_factor',
                'journal_2_name', 'journal_2_papers', 'journal_2_ratio', 'journal_2_impact_factor',
                'journal_3_name', 'journal_3_papers', 'journal_3_ratio', 'journal_3_impact_factor',
                'journal_4_name', 'journal_4_papers', 'journal_4_ratio', 'journal_4_impact_factor',
                'journal_5_name', 'journal_5_papers', 'journal_5_ratio', 'journal_5_impact_factor'
            ];
            
            const actualFields = descriptor.fields.map(f => f.fieldId);
            const missingFields = expectedFields.filter(f => !actualFields.includes(f));
            const extraFields = actualFields.filter(f => !expectedFields.includes(f));
            
            if (missingFields.length === 0 && extraFields.length === 0) {
                resultDiv.innerHTML += log('✓ 字段映射完全匹配', 'success');
            } else {
                if (missingFields.length > 0) {
                    resultDiv.innerHTML += log(`✗ 缺少字段: ${missingFields.join(', ')}`, 'error');
                }
                if (extraFields.length > 0) {
                    resultDiv.innerHTML += log(`✗ 多余字段: ${extraFields.join(', ')}`, 'error');
                }
            }
            
            // 4. 模拟AI解析结果
            resultDiv.innerHTML += log('=== 模拟AI解析结果 ===', 'info');
            
            const mockExtractedData = {
                "total_journals": 20,
                "core_journals_count": 15,
                "q1_journals_papers": 234,
                "high_if_journals_count": 12,
                "journal_1_name": "INTERNATIONAL JOURNAL OF TECHNOLOGY AND DESIGN EDUCATION",
                "journal_1_papers": 86,
                "journal_1_ratio": 13.17,
                "journal_1_impact_factor": 2.45,
                "journal_2_name": "INTERNATIONAL JOURNAL OF ENGINEERING EDUCATION",
                "journal_2_papers": 56,
                "journal_2_ratio": 8.58,
                "journal_2_impact_factor": 1.89,
                "journal_3_name": "THINKING SKILLS AND CREATIVITY",
                "journal_3_papers": 56,
                "journal_3_ratio": 8.58,
                "journal_3_impact_factor": 3.12,
                "journal_4_name": "FRONTIERS IN EDUCATION",
                "journal_4_papers": 33,
                "journal_4_ratio": 5.05,
                "journal_4_impact_factor": 2.78,
                "journal_5_name": "EDUCATION SCIENCES",
                "journal_5_papers": 30,
                "journal_5_ratio": 4.60,
                "journal_5_impact_factor": 2.34
            };
            
            resultDiv.innerHTML += log('模拟AI解析结果:', 'info');
            resultDiv.innerHTML += JSON.stringify(mockExtractedData, null, 2);
            
            // 5. 测试字段匹配
            resultDiv.innerHTML += log('=== 字段匹配测试 ===', 'info');
            
            const matchedFields = descriptor.fields.filter(f => mockExtractedData[f.fieldId] !== undefined);
            resultDiv.innerHTML += log(`匹配字段数量: ${matchedFields.length}/${descriptor.fields.length}`, 'info');
            
            if (matchedFields.length === descriptor.fields.length) {
                resultDiv.innerHTML += log('✓ 所有字段都匹配成功', 'success');
            } else {
                const unmatchedFields = descriptor.fields.filter(f => mockExtractedData[f.fieldId] === undefined);
                resultDiv.innerHTML += log(`✗ 未匹配字段: ${unmatchedFields.map(f => f.fieldId).join(', ')}`, 'error');
            }
            
            // 6. 显示匹配详情
            resultDiv.innerHTML += log('=== 字段匹配详情 ===', 'info');
            matchedFields.forEach(field => {
                resultDiv.innerHTML += log(`${field.fieldId}: ${mockExtractedData[field.fieldId]}`, 'success');
            });
        }

        function testFieldMapping() {
            const resultDiv = document.getElementById('fieldMappingResult');
            resultDiv.innerHTML = '';
            
            resultDiv.innerHTML += log('=== 字段映射验证 ===', 'info');
            
            // 检查模块信息
            if (window.MODULE_INFO && window.MODULE_INFO['journal-distribution']) {
                const moduleInfo = window.MODULE_INFO['journal-distribution'];
                resultDiv.innerHTML += log(`模块名称: ${moduleInfo.name}`, 'info');
                resultDiv.innerHTML += log(`模块描述: ${moduleInfo.description}`, 'info');
                resultDiv.innerHTML += log(`字段数量: ${moduleInfo.fields.length}`, 'info');
                
                resultDiv.innerHTML += log('字段列表:', 'info');
                moduleInfo.fields.forEach((field, index) => {
                    resultDiv.innerHTML += log(`  ${index + 1}. ${field}`, 'info');
                });
            } else {
                resultDiv.innerHTML += log('✗ 未找到期刊分布模块信息', 'error');
            }
        }

        // 页面加载完成后自动运行字段映射测试
        window.addEventListener('load', function() {
            setTimeout(testFieldMapping, 1000);
        });
    </script>
</body>
</html>
