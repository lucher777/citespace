<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek图片采集测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 DeepSeek图片采集测试</h1>
        <p>此页面专门用于测试DeepSeek的图片采集功能是否正常工作。</p>

        <!-- 配置检查 -->
        <div class="test-section">
            <h3>1. 配置检查</h3>
            <button class="btn" onclick="checkConfig()">检查配置</button>
            <div id="configResult"></div>
        </div>

        <!-- 图片上传 -->
        <div class="test-section">
            <h3>2. 图片上传</h3>
            <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
            <div id="imagePreview"></div>
        </div>

        <!-- 格式测试 -->
        <div class="test-section">
            <h3>3. 格式测试</h3>
            <button class="btn" onclick="testFormat()">测试图片格式</button>
            <div id="formatResult"></div>
        </div>

        <!-- API调用测试 -->
        <div class="test-section">
            <h3>4. API调用测试</h3>
            <button class="btn" onclick="testApiCall()">测试API调用</button>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="apiResult"></div>
        </div>

        <!-- 完整测试 -->
        <div class="test-section">
            <h3>5. 完整测试</h3>
            <button class="btn" onclick="runFullTest()">运行完整测试</button>
            <div id="fullTestResult"></div>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="api-config.js"></script>
    <script src="ai-core.js"></script>

    <script>
        let currentImageFile = null;

        // 检查配置
        function checkConfig() {
            const result = document.getElementById('configResult');
            try {
                // 检查API_CONFIG是否加载
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG 未定义');
                }

                // 检查当前配置
                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                const model = API_CONFIG.CURRENT_CONFIG.model;
                const visionModel = API_CONFIG.CURRENT_CONFIG.visionModel;
                const apiKey = API_CONFIG.getStoredApiKey();

                let configInfo = `✅ 配置检查通过\n`;
                configInfo += `当前提供商: ${provider}\n`;
                configInfo += `当前模型: ${model}\n`;
                configInfo += `视觉模型: ${visionModel}\n`;
                configInfo += `API密钥: ${apiKey ? '已配置' : '未配置'}\n`;

                // 检查是否为DeepSeek
                if (provider !== 'deepseek') {
                    configInfo += `⚠️ 当前不是DeepSeek提供商，请切换到DeepSeek进行测试\n`;
                }

                result.innerHTML = `<div class="result info">${configInfo}</div>`;
            } catch (error) {
                result.innerHTML = `<div class="result error">❌ 配置检查失败: ${error.message}</div>`;
            }
        }

        // 预览图片
        function previewImage() {
            const fileInput = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');
            
            if (fileInput.files && fileInput.files[0]) {
                currentImageFile = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="预览图片">`;
                };
                reader.readAsDataURL(currentImageFile);
            }
        }

        // 测试图片格式
        function testFormat() {
            const result = document.getElementById('formatResult');
            
            if (!currentImageFile) {
                result.innerHTML = `<div class="result error">❌ 请先选择图片文件</div>`;
                return;
            }

            try {
                // 检查文件类型
                if (!currentImageFile.type.startsWith('image/')) {
                    throw new Error('不是有效的图片文件');
                }

                // 检查文件大小
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (currentImageFile.size > maxSize) {
                    throw new Error('图片文件过大，请选择小于10MB的图片');
                }

                // 转换为base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1];
                    const formatInfo = `✅ 图片格式检查通过\n`;
                    const formatInfo2 = `文件类型: ${currentImageFile.type}\n`;
                    const formatInfo3 = `文件大小: ${(currentImageFile.size / 1024 / 1024).toFixed(2)}MB\n`;
                    const formatInfo4 = `Base64长度: ${base64.length}字符\n`;
                    const formatInfo5 = `Base64前缀: ${base64.substring(0, 50)}...`;

                    result.innerHTML = `<div class="result success">${formatInfo}${formatInfo2}${formatInfo3}${formatInfo4}${formatInfo5}</div>`;
                };
                reader.readAsDataURL(currentImageFile);
            } catch (error) {
                result.innerHTML = `<div class="result error">❌ 图片格式检查失败: ${error.message}</div>`;
            }
        }

        // 测试API调用
        async function testApiCall() {
            const result = document.getElementById('apiResult');
            const progressBar = document.getElementById('progressBar');
            
            if (!currentImageFile) {
                result.innerHTML = `<div class="result error">❌ 请先选择图片文件</div>`;
                return;
            }

            try {
                result.innerHTML = `<div class="result info">🔄 正在测试API调用...</div>`;
                progressBar.style.width = '10%';

                // 检查配置
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG 未定义');
                }

                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                if (provider !== 'deepseek') {
                    throw new Error('当前不是DeepSeek提供商，请切换到DeepSeek');
                }

                progressBar.style.width = '30%';

                // 获取API配置
                const apiKey = API_CONFIG.getStoredApiKey();
                const apiUrl = API_CONFIG.getApiUrl();
                const headers = API_CONFIG.getApiHeaders(apiKey);
                const model = API_CONFIG.getCurrentModel(true); // 使用视觉模型

                progressBar.style.width = '50%';

                // 构建请求payload
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(currentImageFile);
                });

                const payload = {
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: '你是一个专业的数据分析师，请准确分析图片中的内容。'
                        },
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64Image}`
                                    }
                                },
                                {
                                    type: 'text',
                                    text: '请分析这张图片中的内容，并简要描述你看到了什么。'
                                }
                            ]
                        }
                    ],
                    max_tokens: 500,
                    temperature: 0.1
                };

                progressBar.style.width = '70%';

                // 发送请求
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                progressBar.style.width = '90%';

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} ${response.statusText}\n${errorText}`);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API返回的数据格式不正确');
                }

                const resultText = data.choices[0].message.content;
                
                progressBar.style.width = '100%';

                result.innerHTML = `<div class="result success">✅ API调用成功！\n\nAI回复:\n${resultText}</div>`;

            } catch (error) {
                progressBar.style.width = '0%';
                result.innerHTML = `<div class="result error">❌ API调用失败: ${error.message}</div>`;
            }
        }

        // 运行完整测试
        async function runFullTest() {
            const result = document.getElementById('fullTestResult');
            result.innerHTML = `<div class="result info">🔄 开始运行完整测试...</div>`;

            try {
                // 1. 检查配置
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG 未定义');
                }

                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                if (provider !== 'deepseek') {
                    throw new Error('当前不是DeepSeek提供商，请切换到DeepSeek');
                }

                // 2. 检查图片
                if (!currentImageFile) {
                    throw new Error('请先选择图片文件');
                }

                // 3. 执行API调用
                await testApiCall();

                result.innerHTML = `<div class="result success">✅ 完整测试通过！DeepSeek图片采集功能正常工作。</div>`;

            } catch (error) {
                result.innerHTML = `<div class="result error">❌ 完整测试失败: ${error.message}</div>`;
            }
        }

        // 页面加载时自动检查配置
        window.addEventListener('load', function() {
            checkConfig();
        });
    </script>
</body>
</html>
