<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeekå›¾ç‰‡é‡‡é›†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” DeepSeekå›¾ç‰‡é‡‡é›†æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ä¸“é—¨ç”¨äºæµ‹è¯•DeepSeekçš„å›¾ç‰‡é‡‡é›†åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <!-- é…ç½®æ£€æŸ¥ -->
        <div class="test-section">
            <h3>1. é…ç½®æ£€æŸ¥</h3>
            <button class="btn" onclick="checkConfig()">æ£€æŸ¥é…ç½®</button>
            <div id="configResult"></div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="test-section">
            <h3>2. å›¾ç‰‡ä¸Šä¼ </h3>
            <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
            <div id="imagePreview"></div>
        </div>

        <!-- æ ¼å¼æµ‹è¯• -->
        <div class="test-section">
            <h3>3. æ ¼å¼æµ‹è¯•</h3>
            <button class="btn" onclick="testFormat()">æµ‹è¯•å›¾ç‰‡æ ¼å¼</button>
            <div id="formatResult"></div>
        </div>

        <!-- APIè°ƒç”¨æµ‹è¯• -->
        <div class="test-section">
            <h3>4. APIè°ƒç”¨æµ‹è¯•</h3>
            <button class="btn" onclick="testApiCall()">æµ‹è¯•APIè°ƒç”¨</button>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="apiResult"></div>
        </div>

        <!-- å®Œæ•´æµ‹è¯• -->
        <div class="test-section">
            <h3>5. å®Œæ•´æµ‹è¯•</h3>
            <button class="btn" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="fullTestResult"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="api-config.js"></script>
    <script src="ai-core.js"></script>

    <script>
        let currentImageFile = null;

        // æ£€æŸ¥é…ç½®
        function checkConfig() {
            const result = document.getElementById('configResult');
            try {
                // æ£€æŸ¥API_CONFIGæ˜¯å¦åŠ è½½
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG æœªå®šä¹‰');
                }

                // æ£€æŸ¥å½“å‰é…ç½®
                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                const model = API_CONFIG.CURRENT_CONFIG.model;
                const visionModel = API_CONFIG.CURRENT_CONFIG.visionModel;
                const apiKey = API_CONFIG.getStoredApiKey();

                let configInfo = `âœ… é…ç½®æ£€æŸ¥é€šè¿‡\n`;
                configInfo += `å½“å‰æä¾›å•†: ${provider}\n`;
                configInfo += `å½“å‰æ¨¡å‹: ${model}\n`;
                configInfo += `è§†è§‰æ¨¡å‹: ${visionModel}\n`;
                configInfo += `APIå¯†é’¥: ${apiKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}\n`;

                // æ£€æŸ¥æ˜¯å¦ä¸ºDeepSeek
                if (provider !== 'deepseek') {
                    configInfo += `âš ï¸ å½“å‰ä¸æ˜¯DeepSeekæä¾›å•†ï¼Œè¯·åˆ‡æ¢åˆ°DeepSeekè¿›è¡Œæµ‹è¯•\n`;
                }

                result.innerHTML = `<div class="result info">${configInfo}</div>`;
            } catch (error) {
                result.innerHTML = `<div class="result error">âŒ é…ç½®æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage() {
            const fileInput = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');
            
            if (fileInput.files && fileInput.files[0]) {
                currentImageFile = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="é¢„è§ˆå›¾ç‰‡">`;
                };
                reader.readAsDataURL(currentImageFile);
            }
        }

        // æµ‹è¯•å›¾ç‰‡æ ¼å¼
        function testFormat() {
            const result = document.getElementById('formatResult');
            
            if (!currentImageFile) {
                result.innerHTML = `<div class="result error">âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>`;
                return;
            }

            try {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!currentImageFile.type.startsWith('image/')) {
                    throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (currentImageFile.size > maxSize) {
                    throw new Error('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                }

                // è½¬æ¢ä¸ºbase64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1];
                    const formatInfo = `âœ… å›¾ç‰‡æ ¼å¼æ£€æŸ¥é€šè¿‡\n`;
                    const formatInfo2 = `æ–‡ä»¶ç±»å‹: ${currentImageFile.type}\n`;
                    const formatInfo3 = `æ–‡ä»¶å¤§å°: ${(currentImageFile.size / 1024 / 1024).toFixed(2)}MB\n`;
                    const formatInfo4 = `Base64é•¿åº¦: ${base64.length}å­—ç¬¦\n`;
                    const formatInfo5 = `Base64å‰ç¼€: ${base64.substring(0, 50)}...`;

                    result.innerHTML = `<div class="result success">${formatInfo}${formatInfo2}${formatInfo3}${formatInfo4}${formatInfo5}</div>`;
                };
                reader.readAsDataURL(currentImageFile);
            } catch (error) {
                result.innerHTML = `<div class="result error">âŒ å›¾ç‰‡æ ¼å¼æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testApiCall() {
            const result = document.getElementById('apiResult');
            const progressBar = document.getElementById('progressBar');
            
            if (!currentImageFile) {
                result.innerHTML = `<div class="result error">âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>`;
                return;
            }

            try {
                result.innerHTML = `<div class="result info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...</div>`;
                progressBar.style.width = '10%';

                // æ£€æŸ¥é…ç½®
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG æœªå®šä¹‰');
                }

                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                if (provider !== 'deepseek') {
                    throw new Error('å½“å‰ä¸æ˜¯DeepSeekæä¾›å•†ï¼Œè¯·åˆ‡æ¢åˆ°DeepSeek');
                }

                progressBar.style.width = '30%';

                // è·å–APIé…ç½®
                const apiKey = API_CONFIG.getStoredApiKey();
                const apiUrl = API_CONFIG.getApiUrl();
                const headers = API_CONFIG.getApiHeaders(apiKey);
                const model = API_CONFIG.getCurrentModel(true); // ä½¿ç”¨è§†è§‰æ¨¡å‹

                progressBar.style.width = '50%';

                // æ„å»ºè¯·æ±‚payload
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(currentImageFile);
                });

                const payload = {
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œè¯·å‡†ç¡®åˆ†æå›¾ç‰‡ä¸­çš„å†…å®¹ã€‚'
                        },
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64Image}`
                                    }
                                },
                                {
                                    type: 'text',
                                    text: 'è¯·åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„å†…å®¹ï¼Œå¹¶ç®€è¦æè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆã€‚'
                                }
                            ]
                        }
                    ],
                    max_tokens: 500,
                    temperature: 0.1
                };

                progressBar.style.width = '70%';

                // å‘é€è¯·æ±‚
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                progressBar.style.width = '90%';

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}\n${errorText}`);
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                const resultText = data.choices[0].message.content;
                
                progressBar.style.width = '100%';

                result.innerHTML = `<div class="result success">âœ… APIè°ƒç”¨æˆåŠŸï¼\n\nAIå›å¤:\n${resultText}</div>`;

            } catch (error) {
                progressBar.style.width = '0%';
                result.innerHTML = `<div class="result error">âŒ APIè°ƒç”¨å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const result = document.getElementById('fullTestResult');
            result.innerHTML = `<div class="result info">ğŸ”„ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...</div>`;

            try {
                // 1. æ£€æŸ¥é…ç½®
                if (typeof API_CONFIG === 'undefined') {
                    throw new Error('API_CONFIG æœªå®šä¹‰');
                }

                const provider = API_CONFIG.CURRENT_CONFIG.provider;
                if (provider !== 'deepseek') {
                    throw new Error('å½“å‰ä¸æ˜¯DeepSeekæä¾›å•†ï¼Œè¯·åˆ‡æ¢åˆ°DeepSeek');
                }

                // 2. æ£€æŸ¥å›¾ç‰‡
                if (!currentImageFile) {
                    throw new Error('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                }

                // 3. æ‰§è¡ŒAPIè°ƒç”¨
                await testApiCall();

                result.innerHTML = `<div class="result success">âœ… å®Œæ•´æµ‹è¯•é€šè¿‡ï¼DeepSeekå›¾ç‰‡é‡‡é›†åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚</div>`;

            } catch (error) {
                result.innerHTML = `<div class="result error">âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
        window.addEventListener('load', function() {
            checkConfig();
        });
    </script>
</body>
</html>
